{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Notification Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-gray-100 min-h-screen">
    <div class="flex min-h-screen">
        <!-- Sidebar with Connection Controls -->
        <nav class="w-96 bg-gradient-to-b from-gray-800 to-gray-900 border-r border-gray-600 shadow-2xl p-6 flex flex-col">
            <!-- Connection Section -->
            <div class="bg-gradient-to-br from-blue-900/30 to-blue-800/20 border border-blue-600/50 rounded-xl p-6 shadow-xl mb-6 backdrop-blur-sm">
                <h3 class="text-xl font-bold text-blue-300 mb-6 text-center flex items-center justify-center gap-2">
                    <span class="text-2xl">üîå</span> Connection
                </h3>
                <div class="space-y-4">
                    <div>
                        <label for="wsUrl" class="text-sm text-gray-300 font-medium mb-2 block">WebSocket URL</label>
                        <input type="text" id="wsUrl" value="ws://localhost/ws/notifications/" 
                               class="w-full bg-gray-900/80 text-gray-100 border border-blue-600/50 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-all" 
                               placeholder="Enter WebSocket URL" />
                    </div>
                    <div>
                        <label for="authToken" class="text-sm text-gray-300 font-medium mb-2 block">Authentication Token</label>
                        <div class="relative">
                            <input type="password" id="authToken" 
                                   class="w-full bg-gray-900/80 text-gray-100 border border-blue-600/50 rounded-lg px-3 py-2.5 pr-10 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-all" 
                                   placeholder="Bearer token (optional)" />
                            <button type="button" id="toggleToken" 
                                    class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors">
                                <span id="tokenEye">üëÅÔ∏è</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Leave empty for anonymous connection</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="connectBtn" 
                                class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-lg px-4 py-2.5 text-sm transition-all transform hover:scale-105 shadow-lg">
                            Connect
                        </button>
                        <button type="button" id="disconnectBtn" 
                                class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold rounded-lg px-4 py-2.5 text-sm transition-all transform hover:scale-105 shadow-lg">
                            Disconnect
                        </button>
                    </div>
                    <button type="button" id="reconnectBtn" 
                            class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold rounded-lg px-4 py-2.5 text-sm transition-all transform hover:scale-105 shadow-lg">
                        üîÑ Reconnect
                    </button>
                    <div class="text-center mt-4 p-3 rounded-lg bg-gray-900/50 border border-gray-600">
                        <span id="connectionStatus" class="font-bold text-red-400 text-sm flex items-center justify-center gap-2">
                            <span id="statusIcon" class="text-lg">‚ùå</span>
                            <span id="statusText">Disconnected</span>
                        </span>
                        <div id="connectionDetails" class="text-xs text-gray-500 mt-2 hidden">
                            <div>User ID: <span id="userIdDisplay">-</span></div>
                            <div>Session: <span id="sessionIdDisplay">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Messages -->
            <div class="bg-gradient-to-br from-teal-900/30 to-teal-800/20 border border-teal-600/50 rounded-xl p-6 shadow-xl mb-6 backdrop-blur-sm">
                <h3 class="text-lg font-bold text-teal-300 mb-4 text-center flex items-center justify-center gap-2">
                    <span class="text-xl">üß™</span> Test Messages
                </h3>
                <div class="space-y-3">
                    <button type="button" id="sendPingBtn" 
                            class="w-full bg-gradient-to-r from-teal-600 to-teal-700 hover:from-teal-700 hover:to-teal-800 text-white font-medium rounded-lg px-4 py-2.5 text-sm transition-all transform hover:scale-105 shadow-lg">
                        üèì Send Ping
                    </button>
                </div>
            </div>


        </nav>

        <!-- Main Content: Console Messages -->
        <main class="flex-1 flex flex-col p-6">
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent mb-2">
                    WebSocket Notification Dashboard
                </h1>
                <p class="text-gray-400 text-lg">Real-time notification testing console with advanced debugging</p>
                <div class="mt-3 flex items-center gap-4 text-sm text-gray-500">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        <span>System Ready</span>
                    </div>
                    <div>Messages: <span id="messageCounter" class="text-blue-400 font-semibold">0</span></div>
                    <div>Uptime: <span id="uptime" class="text-green-400 font-semibold">00:00:00</span></div>
                </div>
            </div>

            <!-- Message Controls -->
            <div class="flex flex-wrap gap-3 mb-6 items-center">
                <button type="button" id="clearMessagesBtn" 
                        class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold rounded-lg px-6 py-3 shadow-lg transition-all transform hover:scale-105">
                    üóëÔ∏è Clear Messages
                </button>
                <button type="button" id="toggleDetailBtn" 
                        class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold rounded-lg px-6 py-3 shadow-lg transition-all transform hover:scale-105">
                    üîç Detailed View
                </button>
                
                <!-- Message Display Options -->
                <div class="flex items-center gap-4 ml-auto">
                    <!-- No additional options currently -->
                </div>
            </div>

            <!-- Console Messages -->
            <div class="bg-gradient-to-br from-gray-800 via-gray-900 to-black border-2 border-purple-700/50 rounded-xl p-6 flex-1 shadow-2xl backdrop-blur-sm flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-purple-300 flex items-center gap-2">
                        <span class="text-2xl">üìä</span> Console Messages
                    </h2>
                </div>
                
                <div id="messages" class="bg-black/80 border border-purple-700/50 rounded-lg p-4 flex-1 overflow-y-auto font-mono text-sm relative backdrop-blur-sm flex flex-col">
                    <div id="welcomeMessage" class="flex items-center justify-center h-full">
                        <div class="text-center text-gray-500">
                            <div class="text-4xl mb-4">üöÄ</div>
                            <div class="text-lg mb-2">Welcome to WebSocket Dashboard</div>
                            <div class="text-sm">Connect to start monitoring messages</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Basic WebSocket Dashboard functionality
        let socket = null;
        let messageCounter = 0;
        let detailedView = false;
        let startTime = Date.now();

        // Update uptime counter
        setInterval(() => {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000).toString().padStart(2, '0');
            const minutes = Math.floor((elapsed % 3600000) / 60000).toString().padStart(2, '0');
            const seconds = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
            document.getElementById('uptime').textContent = `${hours}:${minutes}:${seconds}`;
        }, 1000);

        // Add message to console
        function addMessage(type, content, details = null) {
            const messagesDiv = document.getElementById('messages');
            const welcomeMessage = document.getElementById('welcomeMessage');
            
            // Hide welcome message when first message arrives
            if (welcomeMessage && welcomeMessage.style.display !== 'none') {
                welcomeMessage.style.display = 'none';
                // Remove welcome message from DOM to prevent layout issues
                welcomeMessage.remove();
                // Add class to ensure proper layout for messages
                messagesDiv.classList.add('has-messages');
            }

            const messageElement = document.createElement('div');
            messageElement.className = 'mb-3 p-3 rounded-lg border-l-4 flex items-start gap-3 animate-fade-in w-full flex-shrink-0';
            
            const timestamp = new Date().toLocaleTimeString();
            let icon, bgColor, borderColor, textColor;

            switch(type) {
                case 'success':
                    icon = '‚úÖ';
                    bgColor = 'bg-green-900/30';
                    borderColor = 'border-green-400';
                    textColor = 'text-green-300';
                    break;
                case 'error':
                    icon = '‚ùå';
                    bgColor = 'bg-red-900/30';
                    borderColor = 'border-red-400';
                    textColor = 'text-red-300';
                    break;
                case 'warning':
                    icon = '‚ö†Ô∏è';
                    bgColor = 'bg-yellow-900/30';
                    borderColor = 'border-yellow-400';
                    textColor = 'text-yellow-300';
                    break;
                case 'info':
                    icon = '‚ÑπÔ∏è';
                    bgColor = 'bg-blue-900/30';
                    borderColor = 'border-blue-400';
                    textColor = 'text-blue-300';
                    break;
                case 'message':
                    icon = 'üí¨';
                    bgColor = 'bg-purple-900/30';
                    borderColor = 'border-purple-400';
                    textColor = 'text-purple-300';
                    break;
                default:
                    icon = 'üìù';
                    bgColor = 'bg-gray-900/30';
                    borderColor = 'border-gray-400';
                    textColor = 'text-gray-300';
            }

            messageElement.className += ` ${bgColor} ${borderColor}`;
            
            let messageHTML = `
                <div class="text-lg flex-shrink-0">${icon}</div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="${textColor} font-semibold text-xs uppercase tracking-wide">${type}</span>
                        <span class="text-gray-500 text-xs">${timestamp}</span>
                    </div>
                    <div class="text-gray-200 break-words">${content}</div>
            `;

            if (details && detailedView) {
                messageHTML += `<div class="mt-2 text-xs text-gray-400 bg-black/30 rounded p-2 font-mono overflow-x-auto">${JSON.stringify(details, null, 2)}</div>`;
            }

            messageHTML += '</div>';
            messageElement.innerHTML = messageHTML;

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Update counter
            messageCounter++;
            document.getElementById('messageCounter').textContent = messageCounter;
        }

        // Connection handlers
        document.getElementById('connectBtn').addEventListener('click', () => {
            const wsUrl = document.getElementById('wsUrl').value;
            const authToken = document.getElementById('authToken').value;

            if (socket && socket.readyState === WebSocket.OPEN) {
                addMessage('warning', 'Already connected to WebSocket');
                return;
            }

            // Build final URL with token if provided
            let finalUrl = wsUrl;
            if (authToken.trim()) {
                const separator = wsUrl.includes('?') ? '&' : '?';
                finalUrl = `${wsUrl}${separator}token=${encodeURIComponent(authToken.trim())}`;
                addMessage('info', `Connecting to ${wsUrl} (with auth)...`);
            } else {
                addMessage('info', `Connecting to ${wsUrl} (anonymous)...`);
            }

            try {
                socket = new WebSocket(finalUrl);

                socket.onopen = () => {
                    addMessage('success', 'WebSocket connection established');
                    updateConnectionStatus('connected');
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        addMessage('message', `Received: ${data.type || 'Unknown'}`, data);
                        
                        // Handle connection_established message to show user details
                        if (data.type === 'connection_established' && data.data) {
                            document.getElementById('userIdDisplay').textContent = data.data.user_id || '-';
                            document.getElementById('sessionIdDisplay').textContent = 
                                data.data.session_id ? data.data.session_id.slice(0, 8) + '...' : '-';
                        }
                    } catch (e) {
                        addMessage('message', `Received: ${event.data}`);
                    }
                };

                socket.onerror = (error) => {
                    addMessage('error', 'WebSocket error occurred', error);
                    updateConnectionStatus('error');
                };

                socket.onclose = (event) => {
                    addMessage('warning', `Connection closed (code: ${event.code})${event.reason ? ': ' + event.reason : ': No reason provided'}`, event);
                    updateConnectionStatus('disconnected');
                };

            } catch (error) {
                addMessage('error', `Failed to connect: ${error.message}`, error);
                updateConnectionStatus('error');
            }
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            if (socket) {
                socket.close();
                addMessage('info', 'Disconnecting...');
            } else {
                addMessage('warning', 'No active connection to disconnect');
            }
        });

        document.getElementById('reconnectBtn').addEventListener('click', () => {
            if (socket) {
                socket.close();
            }
            setTimeout(() => {
                document.getElementById('connectBtn').click();
            }, 500);
        });

        document.getElementById('sendPingBtn').addEventListener('click', () => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const pingMessage = { type: 'ping', timestamp: new Date().toISOString() };
                socket.send(JSON.stringify(pingMessage));
                addMessage('info', 'Ping sent', pingMessage);
            } else {
                addMessage('error', 'Not connected to WebSocket');
            }
        });

        document.getElementById('clearMessagesBtn').addEventListener('click', () => {
            const messagesDiv = document.getElementById('messages');
            
            // Reset to welcome state and remove has-messages class
            messagesDiv.classList.remove('has-messages');
            messagesDiv.innerHTML = `
                <div id="welcomeMessage" class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <div class="text-4xl mb-4">üöÄ</div>
                        <div class="text-lg mb-2">Welcome to WebSocket Dashboard</div>
                        <div class="text-sm">Connect to start monitoring messages</div>
                    </div>
                </div>
            `;
            
            messageCounter = 0;
            document.getElementById('messageCounter').textContent = '0';
        });

        document.getElementById('toggleDetailBtn').addEventListener('click', () => {
            detailedView = !detailedView;
            const btn = document.getElementById('toggleDetailBtn');
            btn.textContent = detailedView ? 'üîç Simple View' : 'üîç Detailed View';
            addMessage('info', `Detail view ${detailedView ? 'enabled' : 'disabled'}`);
        });

        document.getElementById('toggleToken').addEventListener('click', () => {
            const tokenInput = document.getElementById('authToken');
            const eye = document.getElementById('tokenEye');
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                eye.textContent = 'üôà';
            } else {
                tokenInput.type = 'password';
                eye.textContent = 'üëÅÔ∏è';
            }
        });

        function updateConnectionStatus(status) {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const connectionDetails = document.getElementById('connectionDetails');

            switch(status) {
                case 'connected':
                    statusIcon.textContent = '‚úÖ';
                    statusText.textContent = 'Connected';
                    statusText.className = statusText.className.replace(/text-\w+-400/, 'text-green-400');
                    connectionDetails.classList.remove('hidden');
                    break;
                case 'error':
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = 'Error';
                    statusText.className = statusText.className.replace(/text-\w+-400/, 'text-yellow-400');
                    connectionDetails.classList.add('hidden');
                    break;
                default:
                    statusIcon.textContent = '‚ùå';
                    statusText.textContent = 'Disconnected';
                    statusText.className = statusText.className.replace(/text-\w+-400/, 'text-red-400');
                    connectionDetails.classList.add('hidden');
            }
        }

        // Add CSS for fade-in animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in {
                animation: fade-in 0.3s ease-out;
            }
            #messages {
                display: flex !important;
                flex-direction: column !important;
            }
            #messages.has-messages {
                justify-content: flex-start !important;
                align-items: stretch !important;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>